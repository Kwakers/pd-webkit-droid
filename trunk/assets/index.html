<html>

<head>
	<style>
		* {
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}
		
		body {
			margin: 0px;
			padding: 0px;
			width: 100%;
			height: 100%;
			background-repeat: no-repeat;
			background-position: center center;
			background-image: url(background.png);
			font-family: Arial;
			font-size: 16px;
		}
		
		#page {
			width: 100%;
			height: 100%;
			margin: 0px;
			padding: 0px;
			overflow: hidden;
		}
		
		#loading {
			position: relative;
			text-align: center;
			margin-top: 10px;
			background: #ffffff;
			opacity: 0.8;
			padding: 3px;
			width: 35%;
			border: 1px solid silver;
			margin-left: auto;
			margin-right: auto;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			z-index: 200;
		}
		
		#loading-container {
			position: absolute;
			top: 0px;
			left: 0px;
			margin: 0px;
			padding: 0px;
			width: 100%;
			height: 100%;
			border: 0px solid black;
			background-color: white;
			background-repeat: no-repeat;
			background-position: center center;
			background-image: url(podsixbg.png);
			z-index: 100;
		}
		
		button {
			text-align: center;
			margin-top: 20px;
			background: #ffaaaa;
			opacity: 0.8;
			padding: 3px;
			width: 35%;
			border: 1px solid black;
			margin-left: auto;
			margin-right: auto;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
		}
		
		#clear {
			position: absolute;
			width: 20%;
			right: 3px;
			bottom: 70px;
		}
		
		#record {
			position: absolute;
			width: 20%;
			left: 3px;
			bottom: 70px;
		}
		
		#buttons {
			position: absolute;
			top: 20px;
			width: 100%;
			text-align: center;
			display: none;
		}

		table {
			position: absolute;
			width: 100%;
			bottom: 5px;
		}
		
		td {
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			padding: 2px;
			border: 2px solid gray;
			text-align: center;
		}
		
		#ticker {
			position: absolute;
			border: 2px solid orange;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			width: 12%;
			display: none;
		}
		
		#about, #help {
			position: absolute;
			top: 0px;
			left: 0px;
			margin: 0px;
			padding: 10px;
			width: 100%;
			min-height: 100%;
			background: white;
			display: none;
			overflow-x: hidden;
			overflow-y: scroll;
		}
		
		#about img,button {
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
		
		#logo {
			border: 0px solid black;
		}
		
		#help button {
			display: block;
			margin-left: auto;
			margin-right: auto;
		}
	</style>
	<script>
		function help() {
			document.getElementById("help").style.display = "block";
		}
		
		function about() {
			document.getElementById("about").style.display = "block";
		}
		
		var message = null;
		var messagecounter = 0;
		var messageinterval = null;
		var ticker = null;
		var tickerinit = false;
		var synth_row = [];
		var synth_data = [
			[0, 0, 0, 0, 0, 0, 0, 0, 0,],
			[0, 0, 0, 0, 0, 0, 0, 0, 0,]
		];
		var positions = [];
		var record = false;
		var recordicon = null;
		
		function newMessage(txt) {
			message.innerHTML = txt;
			messagecounter = 0.85;
			message.style.display = "block";
			messageinterval = setTimeout(cancelMessage, 1000);
		}
		
		function cancelMessage() {
			message.style.display = "none";
		}
		
		var colors = ["#FFFFFF", "#2B0000", "#800000", "#D40000", "#FF0000"];
		function generateMousedown(idx, name, id, data) {
			return function(ev) {
				data[idx] = (data[idx] + 1) % 5;
				this.style.backgroundColor = colors[data[idx]];
				Pd.send(name, id + " " + idx + " " + data[idx]);
			}
		}

		function initSynth() {
			for (var s=0; s<2; s++) {
				synth_row[s] = document.getElementById('synths').rows[s].cells;
				for (var i=0; i<synth_row[s].length; i++) {
					synth_row[s][i].innerHTML = "&nbsp;";
					synth_row[s][i].ontouchstart = generateMousedown(i, "synth", s, synth_data[s]);
				}
			}
		}
		
		function launch() {
			message = document.getElementById("loading");
			ticker = document.getElementById("ticker");
			recordicon = document.getElementById("recordicon");
			initSynth();
			var tabletop = parseInt(document.getElementById("synths").offsetTop);
			for (var i=0; i<16; i++) {
				positions[i] = [parseInt(synth_row[Math.floor(i / 8) % 2][i % 8].offsetLeft), parseInt(synth_row[Math.floor(i / 8) % 2][i % 8].offsetTop) + tabletop];
			}
			ticker.style.width = parseInt(synth_row[0][3].offsetLeft) + parseInt(synth_row[0][0].offsetWidth) - parseInt(synth_row[0][0].offsetLeft);
			ticker.style.height = parseInt(synth_row[0][0].offsetHeight);
			document.getElementById("help").style.width = parseInt(window.innerWidth) - 20;
			document.getElementById("about").style.width = parseInt(window.innerWidth) - 20;
			document.getElementById("help").style.minHeight = parseInt(window.innerHeight) - 20;
			document.getElementById("about").style.minHeight = parseInt(window.innerHeight) - 20;
			//document.getElementById("body").style.width = window.innerWidth;
			//document.getElementById("page").style.width = window.innerWidth;
		}
		
		function clearsynth() {
			for (var i=0; i<16; i++) {
				synth_row[Math.floor(i / 8)][i % 8].style.backgroundColor = colors[0];
				Pd.send("synth", Math.floor(i / 8) + " " + (i % 8) + " 0");
				synth_data[Math.floor(i / 8)][i % 8] = 0;
			}
		}
		
		function togglerecord() {
			if (record) {
				// stop recording
				recordicon.src = "stop.png";
				record = false;
				Pd.send("record", "bang");
			} else {
				// start recording
				recordicon.src = "record.png";
				record = true;
				Pd.send("stop", "bang");
			}
		}
		
		function PdReceive(what) {
			if (what == "init") {
				newMessage("fresh beat!");
				document.getElementById("loading-container").style.display = "none";
				document.getElementById("buttons").style.display = "block";
				Pd.sendBang("startticker");
			} else {
				var parts = what.split(" ");
				if (parts[0] == "bar") {
					var tick = parseInt(parts[1]);
					ticker.style.left = positions[tick * 4][0] - 2;
					ticker.style.top = positions[tick * 4][1] - 2;
					if (!tickerinit) {
						ticker.style.display = "block";
						tickerinit = true;
					}
				}
			}
		}
	</script>
</head>

<body onLoad='launch();' onResize='launch();'>
	<div id="page">
		<div id='buttons'><button ontouchstart='Pd.sendBang("shake"); this.style.background="red";' ontouchend='this.style.background="#ffaaaa"'>new beat</button></div>
		<div id='loading-container'></div>
		<div id='loading'>Loading...</div>
		<div id='ticker'></div>
		<button id='clear' onclick='clearsynth();'><img src='close.png'></button>
		<button id='record' onclick='togglerecord();'><img src='record.png' id='recordicon'></button>
		<table id="synths">
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
		</table>
	</div>
	<div id="help">
		<h3>Help</h3>
		<p>CanOfBeats is a HipHop beat generator. Press the 'new beat' button in order to generate a completely original new beat. The 16 small buttons at the bottom of the screen allow you to input melodies. The notes will play left-to-right, one row after another, and you get four notes to play with, each represented by it's own colour.</p>
		<button onclick='document.getElementById("help").style.display = "none";'>Ok</button>
	</div>
	<div id="about">
		<a href='http://podsix.com.au/'><img src='podsix.png' class='logo'></a>
		<p>CanOfBeats is copyright Chris McCormick, 2009, 2010.</p>
		<p>This program is GPLv3 licensed. A copy of the LICENSE.txt is available online <a href='http://mccormick.cx/projects/CanOfBeats/LICENSE.txt'>here</a>.</p>
		<p>Obtain the sourcecode with bzr:<br/><code>bzr co http://mccormick.cx/dev/CanOfBeats-Android.bzr/</code></p>
		<h3>Pure Data</h3>
		<p>This program contains Pure Data by Miller S. Puckette, and pd-for-android by Peter Brinkmann. These are BSD licensed. See the file called LICENSE.txt for details. A copy of that file is available online <a href='http://mccormick.cx/projects/CanOfBeats/LICENSE.txt'>here</a>.</p>
		<button onclick='document.getElementById("about").style.display = "none";'>Ok</button>
	</div>
</body>

</html>
