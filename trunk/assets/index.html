<html>

<head>
	<style>
		* {
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}
		
		body {
			margin: 0px;
			padding: 0px;
			width: 100%;
			height: 100%;
			overflow: hidden;
			background-repeat: no-repeat;
			background-position: center center;
			background-image: url(background.png);
			font-family: Arial;
		}
		
		#loading {
			text-align: center;
			margin-top: 10px;
			background: #ffffff;
			opacity: 0.8;
			padding: 3px;
			width: 35%;
			border: 1px solid silver;
			margin-left: auto;
			margin-right: auto;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
		}
		
		button {
			text-align: center;
			margin-top: 20px;
			background: #ffaaaa;
			opacity: 0.8;
			padding: 3px;
			width: 35%;
			border: 1px solid black;
			margin-left: auto;
			margin-right: auto;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
		}

		#buttons {
			position: absolute;
			top: 20px;
			width: 100%;
			text-align: center;
			display: none;
		}

		table {
			position: absolute;
			width: 100%;
			bottom: 5px;
		}
		
		td {
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			padding: 2px;
			border: 2px solid gray;
			text-align: center;
		}
		
		#ticker {
			position: absolute;
			border: 2px solid orange;
			-webkit-border-radius: 3px;
			-moz-border-radius: 3px;
			width: 12%;
			display: none;
		}
	</style>
	<script>
		var message = null;
		var messagecounter = 0;
		var messageinterval = null;
		var ticker = null;
		var tickerinit = false;
		var synth_row = [];
		var synth_data = [
			[0, 0, 0, 0, 0, 0, 0, 0, 0,],
			[0, 0, 0, 0, 0, 0, 0, 0, 0,]
		];
		var positions = [];
		
		function newMessage(txt) {
			message.innerHTML = txt;
			messagecounter = 0.85;
			message.style.display = "block";
			messageinterval = setTimeout(cancelMessage, 1000);
		}
		
		function cancelMessage() {
			message.style.display = "none";
		}
		
		var colors = ["white", "red", "blue", "black", "gray"];
		function generateMousedown(idx, name, id, data) {
			return function(ev) {
				data[idx] = (data[idx] + 1) % 5;
				this.style.backgroundColor = colors[data[idx]];
				Pd.send(name, id + " " + idx + " " + data[idx]);
			}
		}

		function initSynth() {
			for (var s=0; s<2; s++) {
				synth_row[s] = document.getElementById('synths').rows[s].cells;
				for (var i=0; i<synth_row[s].length; i++) {
					synth_row[s][i].innerHTML = "&nbsp;";
					synth_row[s][i].ontouchstart = generateMousedown(i, "synth", s, synth_data[s]);
				}
			}
		}
		
		function launch() {
			message = document.getElementById("loading");
			ticker = document.getElementById("ticker");
			initSynth();
			var tabletop = document.getElementById("synths").offsetTop;
			for (var i=0; i<16; i++) {
				positions[i] = [parseInt(synth_row[Math.floor(i / 8) % 2][i % 8].offsetLeft), parseInt(synth_row[Math.floor(i / 8) % 2][i % 8].offsetTop) + tabletop];
			}
			ticker.style.width = parseInt(synth_row[0][3].offsetLeft) + parseInt(synth_row[0][0].offsetWidth) - parseInt(synth_row[0][0].offsetLeft);
			ticker.style.height = parseInt(synth_row[0][0].offsetHeight);
		}
		
		function PdReceive(what) {
			if (what == "init") {
				newMessage("fresh beat!");
				document.getElementById("buttons").style.display = "block";
				Pd.sendBang("startticker");
			} else {
				var parts = what.split(" ");
				if (parts[0] == "bar") {
					var tick = parseInt(parts[1]);
					ticker.style.left = positions[tick * 4][0] - 2;
					ticker.style.top = positions[tick * 4][1] - 2;
				}
				if (!tickerinit) {
					ticker.style.display = "block";
					tickerinit = true;
				}
			}
		}
	</script>
</head>

<body onLoad='launch();' onResize='launch();'>
	<div id="page" style="border: 0px solid silver; width: 100%; height: 100%; margin: 0px; padding: 0px; overflow: hidden;">
		<div id='buttons'><button ontouchstart='Pd.sendBang("shake"); this.style.background="red";' ontouchend='this.style.background="#ffaaaa"'>new beat</button></div>
		<div id='loading'>Loading...</div>
		<div id='ticker'></div>
		<table id="synths">
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
		</table>
	</div>
</body>

</html>
